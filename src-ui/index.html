<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/src/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoEQ UI</title>
    <script type="module" src="/src/main.ts" defer></script>
  </head>

  <body>
    <div class="app">
      <main class="main-content">
        <div class="left-panel" id="left-panel">
          <form id="autoeq-form" class="parameter-form">
            <!-- Data Source -->
            <div class="section-group">
              <h3>Data Acquisition</h3>
              <div class="input-source-tabs">
                <label class="tab-label" data-tab="file">
                  <input type="radio" name="input-source" value="file">
                  Files
                </label>
                <label class="tab-label active" data-tab="api">
                  <input type="radio" name="input-source" value="api" checked>
                  Speakers
                </label>
                <label class="tab-label" data-tab="capture">
                  <input type="radio" name="input-source" value="capture">
                  Capture
                </label>
              </div>

              <div id="file-inputs" class="tab-content">
                <div class="compact-row">
                  <input type="text" id="curve-path" name="curve_path" placeholder="Input CSV path">
                  <button type="button" id="browse-curve" class="browse-btn">üìÅ</button>
                </div>
                <div class="compact-row">
                  <input type="text" id="target-path" name="target_path" placeholder="Target CSV path (optional)">
                  <button type="button" id="browse-target" class="browse-btn">üìÅ</button>
                </div>
              </div>

              <div id="api-inputs" class="tab-content active">
                <div class="autocomplete-container">
                  <input type="text" id="speaker" name="speaker" placeholder="Start typing speaker name..." autocomplete="off">
                  <div id="speaker-dropdown" class="autocomplete-dropdown"></div>
                </div>
                <select id="version" name="version" disabled>
                  <option value="">Select Version</option>
                </select>
                <select id="measurement" name="measurement" disabled>
                  <option value="">Select Measurement</option>
                </select>
              </div>

              <div id="capture-inputs" class="tab-content">
                <div class="capture-controls">
                  <button type="button" id="capture-btn" class="capture-button">üé§ Start Capture</button>
                  <div id="capture-status" class="capture-status" style="display: none;">
                    <div class="capture-progress">
                      <span id="capture-status-text">Ready</span>
                      <div class="capture-progress-bar" style="display: none;">
                        <div class="capture-progress-fill" id="capture-progress-fill"></div>
                      </div>
                    </div>
                    <canvas id="capture-waveform" class="capture-waveform" style="display: none;"></canvas>
                  </div>
                  <div id="capture-result" class="capture-result" style="display: none;">
                    <div class="capture-result-info">
                      <span>‚úÖ Captured response ready</span>
                      <button type="button" id="capture-clear" class="capture-clear-btn">Clear</button>
                    </div>
                    <div id="capture-plot" class="capture-plot"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- EQ Design -->
            <div class="section-group">
              <h3>EQ Design</h3>
              <div class="param-grid">
                <!-- Loss Function -->
                <div class="param-item">
                  <label>Loss</label>
                  <select id="loss" name="loss">
                    <option value="flat">Flat</option>
                    <option value="score">Score</option>
                    <option value="mixed">Mixed</option>
                  </select>
                </div>
                <div class="param-item">
                  <label>Filters</label>
                  <input type="number" id="num-filters" name="num_filters" value="7" min="1" max="20">
                </div>

                <!-- Basic Settings -->
                <div class="param-item">
                  <label>Sample Rate</label>
                  <input type="number" id="sample-rate" name="sample_rate" value="48000" step="48000">
                </div>
                <div class="param-item">
                  <label>Curve</label>
                  <select id="curve-name" name="curve_name">
                    <option value="Listening Window">Listening Window</option>
                    <option value="On Axis">On Axis</option>
                    <option value="Early Reflections">Early Reflections</option>
                    <option value="Sound Power">Sound Power</option>
                    <option value="Estimated In-Room Response">Estimated In-Room Response</option>
                  </select>
                </div>

                <!-- dB Range -->
                <div class="param-item">
                  <label>Min dB</label>
                  <input type="number" id="min-db" name="min_db" value="1.0" step="0.1" min="0.1">
                </div>
                <div class="param-item">
                  <label>Max dB</label>
                  <input type="number" id="max-db" name="max_db" value="3.0" step="0.1">
                </div>

                <!-- Q Range -->
                <div class="param-item">
                  <label>Min Q</label>
                  <input type="number" id="min-q" name="min_q" value="1.0" step="0.1">
                </div>
                <div class="param-item">
                  <label>Max Q</label>
                  <input type="number" id="max-q" name="max_q" value="3.0" step="0.1">
                </div>

                <!-- Frequency Range -->
                <div class="param-item">
                  <label>Min Freq</label>
                  <input type="number" id="min-freq" name="min_freq" value="60" step="1">
                </div>
                <div class="param-item">
                  <label>Max Freq</label>
                  <input type="number" id="max-freq" name="max_freq" value="16000" step="100" max="20000">
                </div>
              </div>

              <div class="checkbox-group">
                <label><input type="checkbox" id="iir-hp-pk" name="iir_hp_pk"> Use HP+PK Filters</label>
              </div>
            </div>

            <!-- Optimization Fine Tuning -->
            <div class="section-group">
              <h3>Optimization Fine Tuning</h3>
              <div class="param-grid">
                <!-- Algorithm -->
                <div class="param-item">
                  <label>Algorithm</label>
                  <select id="algo" name="algo">
                    <optgroup label="AutoEQ Algorithms">
                      <option value="autoeq:de" selected>Auto DE (Recommended)</option>
                    </optgroup>
                    <optgroup label="NLOPT Global Optimizers">
                      <option value="nlopt:isres">NLOPT ISRES</option>
                      <option value="nlopt:ags">NLOPT AGS</option>
                      <option value="nlopt:origdirect">NLOPT Original DIRECT</option>
                      <option value="nlopt:crs2lm">NLOPT CRS2 LM</option>
                      <option value="nlopt:direct">NLOPT DIRECT</option>
                      <option value="nlopt:directl">NLOPT DIRECT-L</option>
                      <option value="nlopt:gmlsl">NLOPT GMLSL</option>
                      <option value="nlopt:gmlsllds">NLOPT GMLSL LDS</option>
                      <option value="nlopt:stogo">NLOPT StoGO</option>
                      <option value="nlopt:stogorand">NLOPT StoGO Rand</option>
                    </optgroup>
                    <optgroup label="NLOPT Local Optimizers">
                      <option value="nlopt:cobyla">NLOPT COBYLA</option>
                      <option value="nlopt:bobyqa">NLOPT BOBYQA</option>
                      <option value="nlopt:neldermead">NLOPT Nelder-Mead</option>
                      <option value="nlopt:sbplx">NLOPT Subplex</option>
                      <option value="nlopt:slsqp">NLOPT SLSQP</option>
                    </optgroup>
                    <optgroup label="Metaheuristics">
                      <option value="mh:de">MH Differential Evolution</option>
                      <option value="mh:pso">MH Particle Swarm</option>
                      <option value="mh:rga">MH Genetic Algorithm</option>
                      <option value="mh:tlbo">MH TLBO</option>
                      <option value="mh:firefly">MH Firefly</option>
                    </optgroup>
                  </select>
                </div>

                <!-- DE Strategy Parameters (conditional) -->
                <div class="param-item de-param" id="strategy-param" style="display: none;">
                  <label>Strategy</label>
                  <select id="strategy" name="strategy">
                    <option value="currenttobest1bin" selected>Current-to-Best/1/Bin (Recommended)</option>
                    <option value="rand1bin">Rand/1/Bin</option>
                    <option value="best1bin">Best/1/Bin</option>
                    <option value="rand2bin">Rand/2/Bin</option>
                    <option value="best2bin">Best/2/Bin</option>
                    <option value="randtobest1bin">Rand-to-Best/1/Bin</option>
                    <option value="rand1exp">Rand/1/Exp</option>
                    <option value="best1exp">Best/1/Exp</option>
                    <option value="rand2exp">Rand/2/Exp</option>
                    <option value="best2exp">Best/2/Exp</option>
                    <option value="currenttobest1exp">Current-to-Best/1/Exp</option>
                    <option value="randtobest1exp">Rand-to-Best/1/Exp</option>
                    <option value="adaptivebin">Adaptive/Bin (Experimental)</option>
                    <option value="adaptiveexp">Adaptive/Exp (Experimental)</option>
                  </select>
                </div>

                <!-- Global Algorithm Parameters -->
                <div class="param-item global-algo-param">
                  <label>Population</label>
                  <input type="number" id="population" name="population" value="300" step="1" min="1">
                  <div class="param-warning" id="population-warning-yellow" style="display: none; color: #ffc107; font-size: 0.8em; margin-top: 2px;">‚ö†Ô∏è Values above 3000 may be slow</div>
                  <div class="param-warning" id="population-warning-red" style="display: none; color: #dc3545; font-size: 0.8em; margin-top: 2px;">üö® Values above 30000 will be very slow and may cause issues</div>
                </div>
                <div class="param-item global-algo-param">
                  <label>Max Eval</label>
                  <input type="number" id="maxeval" name="maxeval" value="200000" step="1">
                </div>

                <!-- DE Parameters for mutation and recombination -->
                <div class="param-item de-param" id="mutation-param">
                  <label>F/Mutation</label>
                  <input type="number" id="de-f" name="de_f" value="0.8" step="0.01" min="0.0" max="2.0">
                </div>
                <div class="param-item de-param" id="recombination-param">
                  <label>CR/Recombination</label>
                  <input type="number" id="de-cr" name="de_cr" value="0.9" step="0.01" min="0.0" max="1.0">
                </div>

                <!-- Spacing Parameters -->
                <div class="param-item">
                  <label>Min Spacing</label>
                  <input type="number" id="min-spacing-oct" name="min_spacing_oct" value="0.5" step="0.01">
                </div>
                <div class="param-item">
                  <label>Spacing Weight</label>
                  <input type="number" id="spacing-weight" name="spacing_weight" value="20.0" step="1">
                </div>

                <!-- Tolerance Parameters -->
                <div class="param-item">
                  <label>Tolerance</label>
                  <input type="number" id="tolerance" name="tolerance" value="1e-3" step="1e-12" min="1e-12">
                </div>
                <div class="param-item">
                  <label>Abs Tolerance</label>
                  <input type="number" id="abs-tolerance" name="abs_tolerance" value="1e-4" step="1e-15" min="1e-15">
                </div>


                <!-- Adaptive Weight F (conditional) -->
                <div class="param-item adaptive-param" id="adaptive-weight-f-param" style="display: none;">
                  <label>Adaptive F</label>
                  <input type="number" id="adaptive-weight-f" name="adaptive_weight_f" value="0.8" step="0.01" min="0.1" max="1.0">
                </div>

                <!-- Adaptive Weight CR (conditional) -->
                <div class="param-item adaptive-param" id="adaptive-weight-cr-param" style="display: none;">
                  <label>Adaptive CR</label>
                  <input type="number" id="adaptive-weight-cr" name="adaptive_weight_cr" value="0.7" step="0.01" min="0.1" max="1.0">
                </div>

              </div>

              <div class="param-group-section">
                <div class="param-group-header">Refinement</div>
                <div class="inline-params">
                  <div class="inline-item checkbox-item">
                    <label class="checkbox-label"><input type="checkbox" id="refine" name="refine">Enable</label>
                  </div>
                  <div class="inline-item flex-grow">
                    <label>Local Optimiser</label>
                    <select id="local-algo" name="local_algo" disabled>
                      <option value="cobyla">COBYLA</option>
                      <option value="bobyqa">BOBYQA</option>
                      <option value="newuoa">NEWUOA</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="param-group-section">
                <div class="param-group-header">Smoothing</div>
                <div class="inline-params">
                  <div class="inline-item checkbox-item">
                    <label class="checkbox-label"><input type="checkbox" id="smooth" name="smooth" checked>Enable</label>
                  </div>
                  <div class="inline-item">
                    <label>Smooth N</label>
                    <input type="number" id="smooth-n" name="smooth_n" value="2" min="1" max="24">
                  </div>
                </div>
              </div>
            </div>
          </form>

          <div class="form-actions-sticky">
            <button type="submit" form="autoeq-form" id="optimize-btn" class="optimize-button">Run Optimization</button>
            <button type="button" id="reset-btn" class="reset-button">Reset</button>
          </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="right-panel" id="right-panel">

          <div id="optimization-progress" class="progress-container" style="display: none;">
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <div class="progress-text">Running optimization...</div>
          </div>

          <div id="scores-display" class="scores-display" style="display: none;">
            <h4>Preference Scores</h4>
            <div class="score-grid">
              <div class="score-item">
                <span class="score-label">Before:</span>
                <span id="score-before" class="score-value">--</span>
              </div>
              <div class="score-item">
                <span class="score-label">After:</span>
                <span id="score-after" class="score-value">--</span>
              </div>
              <div class="score-item improvement">
                <span class="score-label">Improvement:</span>
                <span id="score-improvement" class="score-value">--</span>
              </div>
            </div>
          </div>

          <div class="plots-accordion">
            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="filter">
                <h4>Filter Response</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="filter-plot" class="plot-container">No data to display</div>
            </div>

            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="on-axis">
                <h4>On Axis</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="on-axis-plot" class="plot-container">No data to display</div>
            </div>

            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="listening-window">
                <h4>Listening Window</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="listening-window-plot" class="plot-container">No data to display</div>
            </div>

            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="early-reflections">
                <h4>Early Reflections</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="early-reflections-plot" class="plot-container">No data to display</div>
            </div>

            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="sound-power">
                <h4>Sound Power</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="sound-power-plot" class="plot-container">No data to display</div>
            </div>

            <div class="plot-section collapsed">
              <div class="plot-header" data-plot="spin">
                <h4>Spinorama</h4>
                <span class="accordion-arrow">‚ñ∂</span>
              </div>
              <div id="spin-plot" class="plot-container">No data to display</div>
              <div id="spin-plot-corrected" class="plot-container" style="margin-top: 20px;">No data to display</div>
            </div>

            <div class="plot-section expanded">
              <div class="plot-header" data-plot="filter-details">
                <h4>Filter Details
                  <span class="help-tooltip" title="Frequency values are in Hz, Q factors control filter bandwidth (higher Q = narrower filter), and gain values show boost (+) or cut (-) in dB. These parameters can be imported into your audio software or hardware EQ that supports parametric EQ with peak filters.">‚ùì</span>
                </h4>
                <span class="accordion-arrow">‚ñº</span>
              </div>
              <div id="filter-details-plot" class="plot-container">
                <div id="filter-details-table">No data to display</div>
                <div id="filter-details-graph" style="margin-top: 20px; min-height: 400px;"></div>
              </div>
            </div>
          </div>

          <div id="error-display" class="error-display" style="display: none;">
            <h4>Error</h4>
            <div id="error-message" class="error-message"></div>
          </div>
        </div>

        <!-- Audio Testing Controls - moved outside right panel -->
        <div class="audio-testing-controls">
          <div class="audio-control-row">
            <div class="audio-left-controls">
              <label for="demo-audio-select">Demo Track</label>
              <select id="demo-audio-select" name="demo_audio">
                <option value="">Select track...</option>
                <option value="classical">Classical</option>
                <option value="country">Country</option>
                <option value="edm">EDM</option>
                <option value="female_vocal">Female Vocal</option>
                <option value="jazz">Jazz</option>
                <option value="piano">Piano</option>
                <option value="rock">Rock</option>
              </select>
            </div>

            <div class="audio-center-controls">
              <div class="audio-playback-container">
                <div class="audio-status" id="audio-status" style="display: none;">
                  <div class="audio-info-compact">
                    <span id="audio-status-text">Ready</span> ‚Ä¢
                    <span id="audio-position">--:--</span> ‚Ä¢
                    <span id="audio-duration">--:--</span>
                  </div>
                  <div class="audio-progress">
                    <div class="audio-progress-bar">
                      <div class="audio-progress-fill" id="audio-progress-fill" style="width: 0%;"></div>
                    </div>
                  </div>
                </div>

                <!-- Frequency Spectrum Analyzer -->
                <div class="frequency-analyzer" id="frequency-analyzer" style="display: none;">
                  <canvas id="spectrum-canvas"></canvas>
                  <div class="frequency-labels">
                    <span class="freq-label" data-range="sub-bass">Sub Bass<br><small>&lt;60Hz</small></span>
                    <span class="freq-label" data-range="bass">Bass<br><small>60-250Hz</small></span>
                    <span class="freq-label" data-range="low-mid">Low Mid<br><small>250-500Hz</small></span>
                    <span class="freq-label" data-range="mid">Mid<br><small>500-2kHz</small></span>
                    <span class="freq-label" data-range="high-mid">High Mid<br><small>2-4kHz</small></span>
                    <span class="freq-label" data-range="presence">Presence<br><small>4-6kHz</small></span>
                    <span class="freq-label" data-range="brilliance">Brilliance<br><small>6-20kHz</small></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="audio-right-controls">
              <div class="eq-toggle-buttons">
                <button type="button" id="eq-on-btn" class="eq-toggle-btn active">On</button>
                <button type="button" id="eq-off-btn" class="eq-toggle-btn">Off</button>
              </div>
              <button type="button" id="listen-btn" class="listen-button" disabled>
                üéµ Listen
              </button>
              <button type="button" id="stop-btn" class="stop-button" style="display: none;">
                ‚èπÔ∏è Stop
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Optimization Progress Modal -->
    <div id="optimization-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Optimization Progress</h3>
          <button id="modal-close" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="progress-info">
            <div class="progress-status" id="progress-status">Initializing...</div>
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
              </div>
              <div class="progress-percentage" id="progress-percentage">0%</div>
            </div>
          </div>

          <!-- Progress Graph -->
          <div class="progress-graph-container">
            <div id="progress-graph" style="width: 400px; height: 400px;"></div>
          </div>

          <div class="progress-table-container">
            <table class="progress-table" id="progress-table">
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Status</th>
                  <th>Duration</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="progress-table-body">
                <!-- Progress rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancel-optimization" class="btn btn-danger">Cancel Optimization</button>
          <button id="done-optimization" class="btn btn-success" style="display: none;">Done</button>
        </div>
      </div>
    </div>

  </body>
</html>
